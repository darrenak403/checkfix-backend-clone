stages:
  - build
  - push

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE_PREFIX: "datdevv"   # username Docker Hub của bạn

services:
  - docker:27.0.3-dind

default:
  image: docker:27.0.3
  before_script:
    # Login Docker Hub
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  tags:
    - docker


# ================================
# TEMPLATE JOB
# ================================
.build_template: &build_template
  stage: build
  script:
    - docker build -t $IMAGE_NAME:latest $SERVICE_PATH

.push_template: &push_template
  stage: push
  script:
    - docker push $IMAGE_NAME:latest



# ========================================
# EUREKA SERVER
# ========================================
eureka-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/eureka-service"
    SERVICE_PATH: "./eureka-server"
  only:
    changes:
      - eureka-server/**

eureka-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/eureka-service"
  needs:
    - job: eureka-build
      optional: true



# ========================================
# API GATEWAY
# ========================================
gateway-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/api-gateway"
    SERVICE_PATH: "./api-gateway"
  only:
    changes:
      - api-gateway/**

gateway-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/api-gateway"
  needs:
    - job: gateway-build
      optional: true



# ========================================
# IAM SERVICE
# ========================================
iam-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/iam-service"
    SERVICE_PATH: "./iam-service"
  only:
    changes:
      - iam-service/**

iam-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/iam-service"
  needs:
    - job: iam-build
      optional: true



# ========================================
# PATIENT SERVICE
# ========================================
patient-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/patient-service"
    SERVICE_PATH: "./patient-service"
  only:
    changes:
      - patient-service/**

patient-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/patient-service"
  needs:
    - job: patient-build
      optional: true



# ========================================
# TESTORDER SERVICE
# ========================================
testorder-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/testorder-service"
    SERVICE_PATH: "./testorder-service"
  only:
    changes:
      - testorder-service/**

testorder-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/testorder-service"
  needs:
    - job: testorder-build
      optional: true



# ========================================
# WAREHOUSE SERVICE
# ========================================
warehouse-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/warehouse-service"
    SERVICE_PATH: "./warehouse-service"
  only:
    changes:
      - warehouse-service/**

warehouse-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/warehouse-service"
  needs:
    - job: warehouse-build
      optional: true



# ========================================
# INSTRUMENT SERVICE
# ========================================
instrument-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/instrument-service"
    SERVICE_PATH: "./instrument-service"
  only:
    changes:
      - instrument-service/**

instrument-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/instrument-service"
  needs:
    - job: instrument-build
      optional: true



# ========================================
# MONITORING SERVICE
# ========================================
monitoring-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/monitoring-service"
    SERVICE_PATH: "./monitoring-service"
  only:
    changes:
      - monitoring-service/**

monitoring-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/monitoring-service"
  needs:
    - job: monitoring-build
      optional: true



# ========================================
# NOTIFICATION SERVICE
# ========================================
notification-build:
  extends: .build_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/notification-service"
    SERVICE_PATH: "./notification-service"
  only:
    changes:
      - notification-service/**

notification-push:
  extends: .push_template
  variables:
    IMAGE_NAME: "$DOCKER_IMAGE_PREFIX/notification-service"
  needs:
    - job: notification-build
      optional: true
